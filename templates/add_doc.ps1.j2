# AddDoc script for CodeFlattener
# Generated by setup_flattener_vcs.py v{{ version }}

$aiDocsFolder = "{{ ai_docs_folder }}"
$projectSaveFolder = "{{ project_save_folder }}"
$counterFilePath = "{{ counter_file_path }}"
$projectId = {{ project_id }}

# Initialize the counter if it doesn't exist
if (-not (Test-Path -Path "$counterFilePath")) {
    Set-Content -Path "$counterFilePath" -Value "1"
}

# Read the counter value and convert to an integer
$counter = [int](Get-Content -Path "$counterFilePath")

# Get clipboard content
$clipboardContent = Get-Clipboard

if (-not $clipboardContent) {
    Write-Error "Clipboard is empty."
    exit 1
}

# Define save paths
$timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
$projectSavePath = "{{ project_save_folder }}/clipboard_${counter}_${timestamp}.md"
$aiDocsSavePath = "{{ ai_docs_folder }}/clipboard_${counter}_${timestamp}.md"

# Save clipboard content to project save folder
Set-Content -Path $projectSavePath -Value $clipboardContent

# Save clipboard content to .dev/ai_docs folder
Set-Content -Path $aiDocsSavePath -Value $clipboardContent

# Add entry to database
try {
    $dbPath = "{{ db_path }}"

    # Use PowerShell to execute SQLite command - requires sqlite3.exe in path or specify full path
    if (Get-Command "sqlite3" -ErrorAction SilentlyContinue) {
        $tempContent = $clipboardContent -replace "'", "''" # Escape single quotes for SQLite
        $sqlCommand = "INSERT INTO ai_docs (project_id, doc_number, content, created_at) VALUES ($projectId, $counter, '$tempContent', datetime('now'))"
        echo $sqlCommand | sqlite3 $dbPath
    }
    else {
        Write-Warning "sqlite3 command not found. Document saved to files but not in the database."
    }
}
catch {
    Write-Warning "Unable to store in database: $_"
}

# Increment the counter
$counter++

# Save the new counter value
Set-Content -Path "$counterFilePath" -Value $counter

# Print success messages
Write-Host "Clipboard content saved to project save folder: $projectSavePath"
Write-Host "Clipboard content saved to AI docs folder: $aiDocsSavePath"
