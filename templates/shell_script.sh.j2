#!/bin/bash
# Shell script for CodeFlattener
# Generated by setup_flattener_vcs.py v{{ version }}

ROOT_FOLDER="{{ root_folder }}"
DEV_FOLDER="{{ dev_folder }}"
PROJECT_SAVE_FOLDER="{{ project_save_folder }}"
VERSIONS_FOLDER="{{ versions_folder }}"
COUNTER_FILE_PATH="{{ counter_file_path }}"
CURRENT_VERSION={{ version_number }}

# Create a variable to hold the final path
SAVE_PATH="{{ output_file_path }}"

# Define the command
COMMAND="{{ exe_path }} -i . -o $SAVE_PATH"

# Try to run the command
echo "Running CodeFlattener..."
if ! eval "$COMMAND"; then
    echo "Failed to run the command: $COMMAND" >&2
    exit 1
fi

# Run the parser to split the output into the database
echo "Parsing output and storing in database..."
if ! python "{{ parser_script_path }}" "$SAVE_PATH" {{ project_id }} {{ version_id }}; then
    echo "Failed to parse the output" >&2
fi

# Check for updates
UPDATE_PATH="{{ install_dir }}/updater.py"
if [ -f "$UPDATE_PATH" ]; then
    python "$UPDATE_PATH" check | grep "Update available" && {
        echo "Run 'python $UPDATE_PATH update' to update CodeFlattener."
    }
fi

echo "Command executed successfully."
echo "Output version: $SAVE_PATH"
echo "Project ID: {{ project_id }}, Version ID: {{ version_id }}"
